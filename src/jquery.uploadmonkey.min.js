(function($,window,document,undefined){$.fn.UploadMonkey=function(options){return new UploadMonkey(this,options)};$.extend($.fn,{isChildOf:function(parent){return $(this).parents().filter(parent).length>0},outerHtml:function(){return $(this).clone().wrap("<div>").parent().html()}});$.extend($,{isJSON:function(data){try{JSON.parse(data)}catch(e){return false}return true}});var UploadMonkey=function(element,opts){var self=this;var progress={};var clonedInput=null;var i=0;var _defaultOptions={forceIframe:false,
fileLimit:0,multiple:false,queue:null,showQueue:true,queueOptions:{name:true,type:true,size:true,lastModified:true,progressBar:true},resizeMax:null,auto:true,debug:true,dragDrop:true,allowedTypes:null,dropZone:null,dropZoneText:"Drop files here...",fileInput:null,preview:null,dropZoneTextSize:"20px",dzDragOverColor:"#99CCFF",sizeLimit:0,method:"post",action:"upload.php",onComplete:function(response,status,event){},onSuccess:function(response,status,event){},onError:function(response,status,error,
event){},onProgress:function(progressBar,percent,event){},beforeSend:function(data,xhr){}};self.version="0.1.0";self.options={},self.queue=[],self.element=null;self.fileInput=null;self.dropZone=null;self.supportsFileUpload=true;self.options=$.extend(_defaultOptions,opts||{});self.element=element;var _addToQueue=function(file){if(!_checkFileLimit()){_debug("File limit of "+self.options.fileLimit+" has been reached. The queue is full!");return}if(_checkFileType(file)){self.queue.push(file);if(self.options.preview)_previewImage(file)}else _debug("File ("+
file.name+") type "+file.type+" is not allowed.  Ignoring the file.")};var _buildQueueHtml=function(){var options=self.options.queueOptions;_debug("Queue: ");_debug(self.queue);var output=[];for(var i=0,file;file=self.queue[i];i++){var li="<li><span>";if(options.name)li+="<strong>"+escape(file.name)+"</strong>";if(!$.browser.msie){if(options.type)li+=" "+file.type+" ";if(options.size)li+=" "+_bytesToSize(file.size,2);if(options.lastModified)li+=file.lastModifiedDate?" "+file.lastModifiedDate.toLocaleDateString():
" n/a"}li+="</span>";if(options.progressBar&&self.options.method.toUpperCase()==="PUT")li+='<progress id="bar_'+i+'" class="progress-bar" max="100" value="0"></progress>';li+="</li>";output.push(li)}self.options.queue.html('<ul id="queue_list">'+output.join("")+"</ul>");if(options.progressBar){if(self.options.method.toUpperCase()==="POST")self.options.queue.append($('<progress id="bar_filelist" class="progress-bar" max="100" value="0"></progress>'));$("ul#queue_list").find("progress").css("margin-left",
"7px")}self.options.showQueue?self.options.queue.show():self.options.queue.hide()};var _bytesToSize=function(bytes,precision){var sizes=["Bytes","KB","MB","GB","TB"];var posttxt=0;if(bytes===0)return"n/a";while(bytes>=1024){posttxt++;bytes=bytes/1024}return Number(bytes).toFixed(precision)+" "+sizes[posttxt]};var _checkFileApi=function(){return typeof FileReader==="undefined"?false:true};var _checkFileLimit=function(){if(self.queue.length>=self.options.fileLimit&&self.options.fileLimit!==0)return false;
return true};var _checkFileUpload=function(){return typeof window.FormData==="undefined"?false:true};var _checkFileType=function(file){if(!self.options.allowedTypes)return true;var types=self.options.allowedTypes.split(",");$.each(types,function(i,type){types[i]=$.trim(type)});_debug("Allowed file types: ");_debug(types);return $.inArray(file.type,types)>-1?true:false};var _debug=function(output){if(self.options.debug)console.log(output)};var _dragLeave=function(e){_ignoreDrag(e);$(this).css("background-color",
"#FFF")};var _dragOver=function(e){_ignoreDrag(e);$(this).css("background-color",self.options.dzDragOverColor)};var _drop=function(e){var dropZone=self.options.dropZone;$(this).css("background-color","#FFF");var dt=e.originalEvent.dataTransfer;var files=dt.files;if(files.length>0)if(self.options.multiple)$.each(files,function(i,file){_addToQueue(file)});else _addToQueue(files[0]);_buildQueueHtml();if(self.options.auto)self.send();return false};var _ignoreDrag=function(e){e.stopPropagation();e.preventDefault();
return false};var _init=function(){if(self.options.inputFile&&self.element.is("input")){_debug("Can not attach to an input and specify an input. Please choose one!");return}if(self.options.dragDrop&&self.options.dropZone!==null&&self.element.is("div")){_debug("Can not attach to a dropzone and specify a dropzone. Please choose one!");return}_debug("Options: ");_debug(self.options);self.supportsFileUpload=_checkFileUpload();if(self.options.fileInput||self.element.is("input"))_initForm();if(self.options.dragDrop&&
self.options.dropZone!==null||self.element.is("div"))_initDragDrop()};var _initDragDrop=function(isReset){var reset=isReset||false;self.dropZone=self.element.is("div")?self.element:self.options.dropZone;if(!self.dropZone){_debug("No dropZone specified, can not initialize.");return}self.dropZone.html("");self.dropZone.append("<span></span>").css("text-align","center").css("display","table-cell").css("vertical-align","middle");if(_checkFileApi()){self.dropZone.find("span").html(self.options.dropZoneText).addClass("dropzone-text").css("color",
"grey").css("top","50%");if(!reset){var xhr=new XMLHttpRequest;if(xhr.upload){self.dropZone.live("dragover",_dragOver);self.dropZone.live("dragleave",_dragLeave);self.dropZone.live("drop",_drop)}}}else{self.dropZone.find("span").html("Drag and Drop not supported! <br>Update your browser!!!").addClass("dropzone-text").css("color","white").css("top","50%");self.dropZone.css("background-color","red")}};var _initForm=function(){self.fileInput=self.element.is("input")?self.element:self.options.inputFile;
if(self.options.allowedTypes)self.fileInput.attr("accept",self.options.allowedTypes);if(self.fileInput===null||!self.fileInput.is("input"))_debug("No <input> element found");self.fileInput.addClass("upload-input");self.options.multiple?self.fileInput.attr("multiple","multiple"):self.fileInput.removeAttr("multiple");clonedInput=self.fileInput.outerHtml();self.fileInput.live("change",function(e){if($.browser.msie)setTimeout(function(){var file={name:self.fileInput.val().split("\\").pop()};self.queue.push(file);
if(self.options.preview)_previewImage(file);_buildQueueHtml();if(self.options.auto)self.send()},0);else{_debug("Selected files: ");_debug(e.target.files);if(!self.options.multiple)_debug("Selecting multiple files is disabled.");$.each(e.target.files,function(i,file){if(!_checkFileLimit()){_debug("File limit of "+self.options.fileLimit+" has been reached. The queue is full!");return false}self.queue.push(file);if(self.options.preview)_previewImage(file)});_buildQueueHtml();if(self.options.auto)self.send()}})};
var _onIframeOnLoad=function(){var data,success,error,status;content=$(this).contents().find("body").find("pre").length>0?$(this).contents().find("body").find("pre").html():$(this).contents().find("body").html();if($.isJSON(content)){data=$.parseJSON(content);success=data.success.toString();error=data.error?data.error:"Unknown Error";status=data.status?data.status:"Unknown Status"}else try{var title=$(this).contents().find("title").html();var regex=/^\w*\s(.*)$/;status=success=parseInt(title.split(/\b/)[0]);
error=regex.exec(title)[1];data={response:title,status:status,error:error}}catch(e){data={response:"Could not parse response",status:"Unknown Status",error:"Unknown Error"}}if(data!==null){data.success?self.options.onSuccess(data,status,{}):self.options.onError(data,status,error,{});self.options.onComplete(data,success)}else _debug("Could not parse the response.");$(this).remove()};var _previewImage=function(file){if(!_checkFileApi()){_debug("Browser does not support HTML5 File API");return}var reader=
new FileReader,dataUlr=reader.readAsDataURL(file);reader.onloadend=function(e){var result=e.target.result;if(result!==null){var preview=self.options.preview;preview.attr("class","file-preview");var image=$("<img>");image.attr("src",result);image.attr("alt"," ");if(self.options.resizeMax!==null)image.load(function(){_resizeImage(this)});preview.append(image)}}};var _resizeImage=function(image){var max_size=self.options.resizeMax;var h=image.height>image.width?max_size:Math.ceil(image.height/image.width*
max_size);var w=image.height>image.width?Math.ceil(image.width/image.height*max_size):max_size;$(image).css({height:h,width:w})};var _sendFileIframe=function(){var iframe;_debug("Falling back to iFrame hack!");(function buildIframe(index){var id=index>0?"upload_frame_"+index:"upload_frame";iframe=$("iframe#"+id);if(iframe.length<=0){iframe=$("<iframe/>",{name:id,id:id,"class":"hidden",src:"",width:0,height:0,border:0}).appendTo($(document).find("body"));iframe.css("display","none");iframe.one("load",
_onIframeOnLoad)}else{_debug('iFrame with id "'+id+'" already exists');buildIframe(++index)}})(0);if(!self.fileInput.isChildOf("form"))self.fileInput.wrap("<form>");var form=self.fileInput.closest("form");form.attr("action",self.options.action);form.attr("target",iframe.attr("id"));form.attr("method","post");form.attr("enctype","multipart/form-data");form.attr("encoding","multipart/form-data");form.submit()};var _sendFileAjax=function(){var formData=new FormData;$.each(self.queue,function(i,file){formData.append("file-"+
i,file);if(self.options.method.toUpperCase()==="PUT")_sendXHR(file,i)});if(self.options.method.toUpperCase()==="POST")_sendXHR(formData)};var _sendXHR=function(data,index){if(self.options.method.toUpperCase()==="PUT"&&typeof index==="undefined")_debug("PUT request requires queue index, progressBar will not work!");var progressName=self.options.method.toUpperCase()==="PUT"&&typeof index!=="undefined"?"bar_"+index:"bar_filelist";var progressBar=$("progress#"+progressName);if(progressBar)progressBar.show();
var xhr=new XMLHttpRequest;xhr.upload.addEventListener("progress",function(e){if(!e.lengthComputable)self.options.onProgress(null,null,"Unable to compute progress.");var loaded=e.position||e.loaded;var total=e.totalSize||e.total;var percent=Math.round(loaded*100/total);if(progressBar)progressBar.val(percent);self.options.onProgress(progressBar,percent,e)},false);xhr.addEventListener("load",function(e){self.queue.length=0;xhr.status>=200&&xhr.status<300?self.options.onSuccess(e.target.response,e.target.status,
e):self.options.onError(e.target.response,e.target.status,e.target.statusText,e);self.options.onComplete(e.target.response,e.target.status,e)},false);xhr.addEventListener("error",function(e){self.queue.length=0;self.options.onError(e.target.response,e.target.status,e.target.statusText,e);self.options.onComplete(e.target.response,e.target.status,e)},false);xhr.open(self.options.method.toUpperCase(),self.options.action);if(self.options.method.toUpperCase()==="PUT")if(data.name)xhr.setRequestHeader("X-File-Name",
data.name);self.options.beforeSend(data,xhr);xhr.send(data)};self.reset=function(){self.resetQueue();self.resetPreview();self.resetDropzone();self.resetInput();_debug("Reset")};self.resetDropzone=function(){_initDragDrop(true);_debug("Dropzone Reset")};self.resetInput=function(){if(self.fileInput!==null)self.fileInput.replaceWith(clonedInput);self.fileInput=$("input.upload-input");_debug("Input Reset")};self.resetQueue=function(){self.queue.length=0;self.options.queue.html("");_debug("Queue reset");
_debug("Queue: ");_debug(self.queue)};self.resetPreview=function(){if(self.options.preview)self.options.preview.html("");_debug("Preview Cleared")};self.getQueue=function(){_debug("Queue: ");_debug(self.queue)};self.send=function(){if(self.queue.length<=0){_debug("No files to upload");return}self.supportsFileUpload&&!self.options.forceIframe?_sendFileAjax():_sendFileIframe()};_init()}})(jQuery,window,document);