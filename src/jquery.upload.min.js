(function(c,s,t){c.fn.Upload=function(c){return new l(this,c)};c.extend(c.fn,{isChildOf:function(k){return 0<c(this).parents().filter(k).length},outerHtml:function(){return c(this).clone().wrap("<div>").parent().html()}});var l=function(k,l){var a=this,o=null;a.version="0.0.1";a.options={};a.queue=[];a.element=null;a.fileInput=null;a.dropZone=null;a.supportsFileUpload=!0;a.options=c.extend({fileLimit:0,multiple:!1,queue:null,showQueue:!0,queueOptions:{name:!0,type:!0,size:!0,lastModified:!0,progressBar:!0},
resizeMax:null,auto:!0,debug:!0,dragDrop:!0,fileType:"image",allowedExts:null,dropZone:null,dropZoneText:"Drop files here...",fileInput:null,preview:null,dropZoneTextSize:"20px",dzDragOverColor:"#99CCFF",sizeLimit:0,method:"post",action:"upload.php",onComplete:function(){},onSuccess:function(){},onError:function(){},onProgress:function(){},beforeSend:function(){}},l||{});a.element=k;var m=function(){var b=a.options.queueOptions;e("Queue: ");e(a.queue);for(var f=[],g=0,h;h=a.queue[g];g++){var d="<li><span>";
b.name&&(d+="<strong>"+escape(h.name)+"</strong>");if(!c.browser.msie){b.type&&(d+=" "+h.type+" ");if(b.size){var i;i=h.size;var u=["Bytes","KB","MB","GB","TB"],j=0;if(0==i)i="n/a";else{for(;1024<=i;)j++,i/=1024;i=Number(i).toFixed(2)+" "+u[j]}d+=" "+i}b.lastModified&&(d+=h.lastModifiedDate?" "+h.lastModifiedDate.toLocaleDateString():" n/a")}d+="</span>";b.progressBar&&"PUT"===a.options.method.toUpperCase()&&(d+='<progress id="bar_'+g+'" class="progress-bar" max="100" value="0"></progress>');d+="</li>";
f.push(d)}a.options.queue.html('<ul id="queue_list">'+f.join("")+"</ul>");b.progressBar&&("POST"===a.options.method.toUpperCase()&&a.options.queue.append(c('<progress id="bar_filelist" class="progress-bar" max="100" value="0"></progress>')),c("#queue_list").find("progress").css("margin-left","7px"));a.options.showQueue?a.options.queue.show():a.options.queue.hide()},n=function(){return a.queue.length>=a.options.fileLimit&&0!=a.options.fileLimit?!1:!0},e=function(b){a.options.debug&&console.log(b)},
v=function(a){p(a);c(this).css("background-color","#FFF")},w=function(b){p(b);c(this).css("background-color",a.options.dzDragOverColor)},x=function(b){c(this).css("background-color","#FFF");b=b.originalEvent.dataTransfer.files;if(0<b.length)if(a.options.multiple)c.each(b,function(b,c){if(!n())return e("File limit of "+a.options.fileLimit+" has been reached. The queue is full!"),!1;a.queue.push(c);a.options.preview&&j(c)});else{b=b[0];if(!n())return e("File limit of "+a.options.fileLimit+" has been reached. The queue is full!"),
!1;a.queue.push(b);a.options.preview&&j(b)}m();a.options.auto&&a.send();return!1},p=function(a){a.stopPropagation();a.preventDefault();return!1},q=function(b){b=b||!1;a.dropZone=a.element.is("div")?a.element:a.options.dropZone;a.dropZone?(a.dropZone.html(""),a.dropZone.append("<span></span>").css("text-align","center").css("display","table-cell").css("vertical-align","middle"),"undefined"===typeof FileReader?(a.dropZone.find("span").html("Drag and Drop not supported! <br>Update your browser!!!").addClass("dropzone-text").css("color",
"white").css("top","50%"),a.dropZone.css("background-color","red")):(a.dropZone.find("span").html(a.options.dropZoneText).addClass("dropzone-text").css("color","grey").css("top","50%"),!b&&(new XMLHttpRequest).upload&&(a.dropZone.live("dragover",w),a.dropZone.live("dragleave",v),a.dropZone.live("drop",x)))):e("No dropZone specified, can not initialize.")},y=function(){content=0<c(this).contents().find("body").find("pre").length?c(this).contents().find("body").find("pre").html():c(this).contents().find("body").html();
var b=c.parseJSON(content);null!==b?(b.success?a.options.onSuccess(b,b.success.toString()):a.options.onError(b,b.success.toString()),a.options.onComplete(b,b.success.toString())):e("Response was not valid JSON")},j=function(b){if("undefined"===typeof FileReader)e("Browser does not support HTML5 File API");else{var f=new FileReader;f.readAsDataURL(b);f.onloadend=function(b){b=b.target.result;if(null!==b){var e=a.options.preview;e.attr("class","file-preview");var d=c("<img>");d.attr("src",b);d.attr("alt",
" ");null!==a.options.resizeMax&&d.load(function(){var b=a.options.resizeMax,d=this.height>this.width?b:Math.ceil(this.height/this.width*b),b=this.height>this.width?Math.ceil(this.width/this.height*b):b;c(this).css({height:d,width:b})});e.append(d)}}}},r=function(b,f){"PUT"===a.options.method.toUpperCase()&&"undefined"===typeof f&&e("PUT request requires queue index, progressBar will not work!");var g="PUT"===a.options.method.toUpperCase()&&"undefined"!==typeof f?"bar_"+f:"bar_filelist",h=c("#"+g);
h&&h.show();var d=new XMLHttpRequest;d.upload.addEventListener("progress",function(b){if(!b.lengthComputable)a.options.onProgress("Unable to compute progress.");var d=Math.round(100*(b.position||b.loaded)/(b.totalSize||b.total));h&&h.val(d);a.options.onProgress(g,d,b)},!1);d.addEventListener("load",function(b){a.queue.length=0;a.options.onSuccess(b.target.response,b.target.status,b)},!1);d.addEventListener("error",function(b){a.queue.length=0;a.options.onError(b.target.response,b.target.status,b)},
!1);d.open(a.options.method.toUpperCase(),a.options.action);"PUT"===a.options.method.toUpperCase()&&b.name&&d.setRequestHeader("X-File-Name",b.name);a.options.beforeSend(b,d);d.send(b)};a.reset=function(){a.resetQueue();a.resetPreview();a.resetDropzone();a.resetInput();e("Reset")};a.resetDropzone=function(){q(!0);e("Dropzone Reset")};a.resetInput=function(){null!=a.fileInput&&a.fileInput.replaceWith(o);a.fileInput=c(".upload-input");e("Input Reset")};a.resetQueue=function(){a.queue.length=0;a.options.queue.html("");
e("Queue reset");e("Queue: ");e(a.queue)};a.resetPreview=function(){a.options.preview&&a.options.preview.html("");e("Preview Cleared")};a.getQueue=function(){e("Queue: ");e(a.queue)};a.send=function(){if(0>=a.queue.length)e("No files to upload");else if(a.supportsFileUpload){var b=new FormData;c.each(a.queue,function(c,d){b.append("file-"+c,d);"PUT"===a.options.method.toUpperCase()&&r(d,c)});"POST"===a.options.method.toUpperCase()&&r(b)}else{var f;e("Can not use normal input, falling back to iFrame hack!");
(function d(a){var b=0<a?"upload_frame_"+a:"upload_frame";f=c("#"+b);0>=f.length?(f=c("<iframe/>",{name:b,id:b,"class":"hidden",src:"",width:0,height:0,border:0}).appendTo(c(t).find("body")),f.css("display","none"),f.one("load",y)):(e('iFrame with id "'+b+'" already exists'),d(++a))})(0);a.fileInput.isChildOf("form")||a.fileInput.wrap("<form>");var g=a.fileInput.closest("form");g.attr("action",a.options.action);g.attr("target",f.attr("id"));g.attr("method","post");g.attr("enctype","multipart/form-data");
g.attr("encoding","multipart/form-data");g.submit()}};if(a.options.inputFile&&a.element.is("input"))e("Can not attach to an input and specify an input. Please choose one!");else if(a.options.dragDrop&&null!==a.options.dropZone&&a.element.is("div"))e("Can not attach to a dropzone and specify a dropzone. Please choose one!");else{e("Options: ");e(a.options);a.supportsFileUpload="undefined"===typeof s.FormData?!1:!0;if(a.options.fileInput||a.element.is("input"))a.fileInput=a.element.is("input")?a.element:
a.options.inputFile,(null==a.fileInput||!a.fileInput.is("input"))&&e("No <input> element found"),a.fileInput.addClass("upload-input"),a.options.multiple?a.fileInput.attr("multiple","multiple"):a.fileInput.removeAttr("multiple"),o=a.fileInput.outerHtml(),a.fileInput.live("change",function(b){c.browser.msie?setTimeout(function(){var b={name:a.fileInput.val().split("\\").pop()};a.queue.push(b);a.options.preview&&j(b);m();a.options.auto&&a.send()},0):(e("Selected files: "),e(b.target.files),a.options.multiple||
e("Selecting multiple files is disabled."),c.each(b.target.files,function(b,c){if(!n())return e("File limit of "+a.options.fileLimit+" has been reached. The queue is full!"),!1;a.queue.push(c);a.options.preview&&j(c)}),m(),a.options.auto&&a.send())});(a.options.dragDrop&&null!==a.options.dropZone||a.element.is("div"))&&q()}}})(jQuery,window,document);